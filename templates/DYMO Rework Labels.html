        <!-- ...existing code... -->
    <script>
    // Utility function to get formatted date string
    function getFormattedDate() {
        const now = new Date();
        return now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0');
    }
    </script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMG Rework Log & Label Printer</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>
    <script src="/static/dymo.connect.framework.js"></script>
    <style>
        /* Modern & Clean Design */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f4f7f9;
            --card-background: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        #inspDescriptionSelect {
            max-width: 400px;
            width: 100%;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 0;
        select:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        button {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:active {
            transform: translateY(1px);
        }

        .alert-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            text-align: left;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .scrap-and-remake-fields {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 540px; margin: 40px auto; background: var(--card-background); border-radius: 12px; box-shadow: 0 8px 24px var(--shadow-color); padding: 40px 32px 32px 32px; text-align: center;">
        <h1 style="color: var(--primary-color); margin-bottom: 20px;">DMG Rework Log & Label Printer</h1>
        <p style="margin-bottom: 24px;">Please upload all required files and then fill out the form to log a rework event.</p>

        <button class="btn btn-toggle" style="margin-bottom: 18px;" onclick="toggleAdminPanel()">Open Admin Panel</button>

    <div id="admin-panel" style="display:none; text-align:left;">
            <h3>Admin Panel</h3>
            <p>Manage a unique webhook URL for each disposition below, and upload/refresh static files as needed.</p>

            <div class="input-group">
                <label style="flex:1;">Upload <span style="color: var(--secondary-color);">inspectioncode.xlsx</span>:</label>
                <form id="inspcode-upload-form" enctype="multipart/form-data" style="flex:2;display:flex;gap:10px;" onsubmit="uploadInspCode(event)">
                    <input type="file" id="inspcode-file" accept=".xlsx" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
                    <button type="submit" class="btn btn-primary">Upload & Refresh</button>
                </form>
            </div>
            <div id="inspcode-upload-status" class="mt-2 text-sm"></div>

            <div class="input-group">
                <label style="flex:1;">Upload <span style="color: var(--secondary-color);">ReworkLabel.dymo</span> (label format):</label>
                <form id="reworklabel-upload-form" enctype="multipart/form-data" style="flex:2;display:flex;gap:10px;" onsubmit="uploadReworkLabel(event)">
                    <input type="file" id="reworklabel-file" accept=".dymo" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
                    <button type="submit" class="btn btn-primary">Upload Label</button>
                </form>
            </div>
            <div id="reworklabel-upload-status" class="mt-2 text-sm"></div>

            <form id="webhook-form" onsubmit="saveWebhooks(event)">
                <div class="input-group"><label style="flex:1;">Scrap and Remake Webhook:</label><input type="text" id="webhook-scrap" placeholder="Enter webhook URL for Scrap and Remake" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label style="flex:1;">Recoat Webhook:</label><input type="text" id="webhook-recoat" placeholder="Enter webhook URL for Recoat" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label style="flex:1;">DA and Recoat Webhook:</label><input type="text" id="webhook-da" placeholder="Enter webhook URL for DA and Recoat" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label style="flex:1;">Burn off and Blast Webhook:</label><input type="text" id="webhook-burn" placeholder="Enter webhook URL for Burn off and Blast" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label style="flex:1;">Other Rework Webhook:</label><input type="text" id="webhook-other" placeholder="Enter webhook URL for Other Rework" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px;">Save Webhooks</button>
            </form>
            <div id="webhook-save-status" class="mt-2 text-sm"></div>
            <button class="btn btn-toggle" style="margin-top:10px;background-color:var(--primary-color);" onclick="toggleAdminPanel()">Close Admin Panel</button>
        <script>
        // Ensure showAlert is defined before any usage
        function showAlert(message, type) {
            var alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = 'alert-box ' + type;
            alertBox.style.display = 'block';
        }
        
        // Ensure JS runs after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            fetchInspectionCodes();
        });
        // --- Upload inspectioncode.xlsx ---
        async function uploadInspCode(event) {
            event.preventDefault();
            const fileInput = document.getElementById('inspcode-file');
            const statusDiv = document.getElementById('inspcode-upload-status');
            if (!fileInput.files.length) {
                statusDiv.textContent = 'Please select a file.';
                statusDiv.className = 'text-red-600';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            statusDiv.textContent = 'Uploading...';
            statusDiv.className = 'text-gray-600';
            try {
                const response = await fetch('/upload_inspcode', {
                    method: 'POST',
                    body: formData
                });
                let result;
                try {
                    result = await response.json();
                } catch (err) {
                    statusDiv.textContent = 'Server error: Not a JSON response.';
                    statusDiv.className = 'text-red-600';
                    return;
                }
                if (response.ok) {
                    statusDiv.textContent = result.message || 'Upload successful!';
                    statusDiv.className = 'text-green-700';
                } else {
                    statusDiv.textContent = result.error || 'Upload failed.';
                    statusDiv.className = 'text-red-600';
                }
            } catch (e) {
                statusDiv.textContent = 'Error: ' + e.message;
                statusDiv.className = 'text-red-600';
            }
        }

        // --- Upload ReworkLabel.dymo ---
        async function uploadReworkLabel(event) {
            event.preventDefault();
            const fileInput = document.getElementById('reworklabel-file');
            const statusDiv = document.getElementById('reworklabel-upload-status');
            if (!fileInput.files.length) {
                statusDiv.textContent = 'Please select a file.';
                statusDiv.className = 'text-red-600';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            statusDiv.textContent = 'Uploading...';
            statusDiv.className = 'text-gray-600';
            try {
                const response = await fetch('/upload_reworklabel', {
                    method: 'POST',
                    body: formData
                });
                let result;
                try {
                    result = await response.json();
                } catch (err) {
                    statusDiv.textContent = 'Server error: Not a JSON response.';
                    statusDiv.className = 'text-red-600';
                    return;
                }
                if (response.ok) {
                    statusDiv.textContent = result.message || 'Upload successful!';
                    statusDiv.className = 'text-green-700';
                } else {
                    statusDiv.textContent = result.error || 'Upload failed.';
                    statusDiv.className = 'text-red-600';
                }
            } catch (e) {
                statusDiv.textContent = 'Error: ' + e.message;
                statusDiv.className = 'text-red-600';
            }
        }
        </script>
<script>
// Ensure JS runs after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    fetchInspectionCodes();
    showAlert('JS loaded and running!', 'alert-success');
});
</script>
        </div>

        <hr style="margin: 32px 0 24px 0;">
        <form id="rework-form" style="text-align:left;">
            <div class="input-group">
                <label for="jobNoInput" style="flex:1;">Enter Job Number:</label>
                <input type="text" id="jobNoInput" placeholder="e.g., H0624-0000" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
            </div>
            <div class="input-group">
                <label for="dispositionSelect" style="flex:1;">Choose Disposition:</label>
                <select id="dispositionSelect" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
                    <option value="">-- Select Disposition --</option>
                    <option value="Scrap and Remake">Scrap and Remake</option>
                    <option value="Recoat">Recoat</option>
                    <option value="DA and Recoat">DA and Recoat</option>
                    <option value="Burn off and Blast">Burn off and Blast</option>
                    <option value="Other Rework">Other Rework</option>
                </select>
            </div>
            <div class="input-group">
                <label for="inspDescriptionSelect" style="flex:1;">Choose Inspection Description:</label>
                <select id="inspDescriptionSelect" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
                    <option value="">-- Loading inspection codes... --</option>
                </select>
            </div>
            <div class="input-group">
                <label for="inspCodeInputForm" style="flex:1;">Inspection Code (Auto-populated):</label>
                <input type="text" id="inspCodeInputForm" readonly style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
            </div>
            <div class="input-group">
                <label for="clockNoInput" style="flex:1;">Enter Clock Number:</label>
                <input type="text" id="clockNoInput" placeholder="e.g., MO0830" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
            </div>
            <div class="input-group">
                <label for="quantityInput" style="flex:1;">Enter Quantity:</label>
                <input type="number" id="quantityInput" value="1" min="1" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
            </div>
            <div class="input-group">
                <label for="commentInput" style="flex:1;">Enter Comment (optional):</label>
                <input type="text" id="commentInput" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;">
            </div>
            <div id="scrapFields" class="scrap-and-remake-fields" style="margin-top:16px;">
                <hr>
                <h2 style="margin-bottom:12px;">Scrap & Remake Details</h2>
                <div class="input-group"><label for="programNoInput" style="flex:1;">Program Number:</label><input type="text" id="programNoInput" placeholder="e.g., P0123-A" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label for="newDescriptionInput" style="flex:1;">Description:</label><input type="text" id="newDescriptionInput" placeholder="e.g., 2000-00-000-000" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label for="xAxisInput" style="flex:1;">X Axis:</label><input type="text" id="xAxisInput" placeholder="e.g., 20.5" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label for="yAxisInput" style="flex:1;">Y Axis:</label><input type="text" id="yAxisInput" placeholder="e.g., 10.25" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
                <div class="input-group"><label for="gaugeMaterialInput" style="flex:1;">Gauge/Material:</label><input type="text" id="gaugeMaterialInput" placeholder="e.g., .060 Steel" style="flex:2;padding:12px;border:1px solid var(--border-color);border-radius:6px;font-size:16px;"></div>
            </div>
            <button type="button" class="btn btn-primary" style="width:100%;margin-top:18px;" onclick="logReworkAndPrint()">Log Rework & Print Label</button>
        </form>
        <button class="btn btn-toggle" style="width:100%;background-color:#7f8c8d;margin-top:18px;" onclick="window.location.href='/'">Return to Home</button>
        <div id="alertBox" class="alert-box"></div>
    </div>

    <script>
        // --- Admin Panel Webhook Save Handler ---
        async function saveWebhooks(event) {
            event.preventDefault();
            const data = {
                'Scrap and Remake': document.getElementById('webhook-scrap').value.trim(),
                'Recoat': document.getElementById('webhook-recoat').value.trim(),
                'DA and Recoat': document.getElementById('webhook-da').value.trim(),
                'Burn off and Blast': document.getElementById('webhook-burn').value.trim(),
                'Other Rework': document.getElementById('webhook-other').value.trim()
            };
            try {
                const response = await fetch('/api/disposition_webhooks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('webhook-save-status').textContent = 'Webhooks saved successfully!';
                } else {
                    document.getElementById('webhook-save-status').textContent = 'Error: ' + (result.error || 'Unknown error');
                }
            } catch (e) {
                document.getElementById('webhook-save-status').textContent = 'Error saving webhooks: ' + e.message;
            }
        }

        // Load webhooks from backend and populate fields
        async function loadWebhooks() {
            try {
                const response = await fetch('/api/disposition_webhooks');
                const webhooks = await response.json();
                if (Array.isArray(webhooks)) {
                    for (const w of webhooks) {
                        if (w.disposition === 'Scrap and Remake') document.getElementById('webhook-scrap').value = w.webhook_url;
                        if (w.disposition === 'Recoat') document.getElementById('webhook-recoat').value = w.webhook_url;
                        if (w.disposition === 'DA and Recoat') document.getElementById('webhook-da').value = w.webhook_url;
                        if (w.disposition === 'Burn off and Blast') document.getElementById('webhook-burn').value = w.webhook_url;
                        if (w.disposition === 'Other Rework') document.getElementById('webhook-other').value = w.webhook_url;
                    }
                }
            } catch (e) {
                document.getElementById('webhook-save-status').textContent = 'Error loading webhooks: ' + e.message;
            }
        }

        // Enhance toggleAdminPanel to load webhooks when opening
        function toggleAdminPanel() {
            const panel = document.getElementById('admin-panel');
            const button = document.querySelector('.btn-toggle');
            if (panel.style.display === "block") {
                panel.style.display = "none";
                button.textContent = "Open Admin Panel";
            } else {
                const password = prompt("Please enter the password to open the admin panel:");
                if (password === 'password123') {
                    panel.style.display = "block";
                    button.textContent = "Close Admin Panel";
                    loadWebhooks();
                } else {
                    showAlert("Incorrect password.", 'alert-error');
                }
            }
        }
        var inspCodeData = null;
        var reworkLabelXml = null;
        // Fetch inspection codes from API and populate dropdown
        async function fetchInspectionCodes() {
            try {
                const response = await fetch('/api/inspection_codes');
                if (!response.ok) {
                    showAlert('Could not load inspection codes from server.', 'alert-error');
                    return;
                }
                const codes = await response.json();
                var dropdown = document.getElementById('inspDescriptionSelect');
                if (!dropdown) {
                    showAlert('Dropdown element not found!', 'alert-error');
                    return;
                }
                dropdown.innerHTML = '<option value="">-- Select Inspection Description --</option>';
                codes.forEach(item => {
                    if (item.description && typeof item.code === 'string') {
                        // Pad code to 4 characters with leading zeros if needed
                        var code = item.code.padStart(4, '0');
                        var option = document.createElement('option');
                        option.value = code;
                        option.textContent = item.description;
                        dropdown.appendChild(option);
                    }
                });
                // Auto-populate inspCodeInputForm if a valid option is selected
                if (dropdown.options.length > 1) {
                    dropdown.selectedIndex = 1;
                    document.getElementById('inspCodeInputForm').value = dropdown.options[1].value;
                }
            } catch (e) {
                showAlert('Could not load inspection codes from server.', 'alert-error');
            }
        }

        // Function to clear form fields
        function clearFormFields() {
    try {
        document.getElementById('jobNoInput').value = '';
        document.getElementById('dispositionSelect').value = '';
        document.getElementById('inspDescriptionSelect').value = '';
        document.getElementById('inspCodeInputForm').value = '';
        document.getElementById('clockNoInput').value = '';
        document.getElementById('quantityInput').value = '1';
        document.getElementById('commentInput').value = '';
        // NEW: Also clear the scrap fields
        clearScrapFields();
    } catch (e) {
        console.error('Error clearing form fields:', e);
    }
        }

        // NEW: Function to clear the Scrap and Remake fields
        function clearScrapFields() {
            document.getElementById('programNoInput').value = '';
            document.getElementById('newDescriptionInput').value = '';
            document.getElementById('xAxisInput').value = '';
            document.getElementById('yAxisInput').value = '';
            document.getElementById('gaugeMaterialInput').value = '';
        }

        // NEW: Event listener to show/hide the Scrap and Remake fields
        // Add event listeners after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Disposition select event
            var dispositionSelect = document.getElementById('dispositionSelect');
            if (dispositionSelect) {
                dispositionSelect.addEventListener('change', function(event) {
                    var scrapFieldsDiv = document.getElementById('scrapFields');
                    if (event.target.value === 'Scrap and Remake') {
                        scrapFieldsDiv.style.display = 'block';
                    } else {
                        scrapFieldsDiv.style.display = 'none';
                        clearScrapFields(); // Clear fields when they are hidden
                    }
                });
            }
            // Inspection description select event
            var inspDescriptionSelect = document.getElementById('inspDescriptionSelect');
            if (inspDescriptionSelect) {
                inspDescriptionSelect.addEventListener('change', function(event) {
                    var selectedOption = event.target.options[event.target.selectedIndex];
                    var selectedCode = selectedOption.value;
                    document.getElementById('inspCodeInputForm').value = selectedCode || '';
                });
            }
        });

        
        function populateDescriptionDropdown(data) {
            var dropdown = document.getElementById('inspDescriptionSelect');
            dropdown.innerHTML = '<option value="">-- Select Inspection Description --</option>';
            
            data.forEach(item => {
                if (item.Description) {
                    var option = document.createElement('option');
                    option.value = item['Inspection Code'];
                    option.textContent = item.Description;
                    dropdown.appendChild(option);
                }
            });
        }
        
        document.getElementById('inspDescriptionSelect').addEventListener('change', function(event) {
            console.log('Dropdown selectedIndex:', event.target.selectedIndex);
            for (let i = 0; i < event.target.options.length; i++) {
                console.log('Change event option', i, 'text:', event.target.options[i].text, 'value:', event.target.options[i].value);
            }
            var selectedOption = event.target.options[event.target.selectedIndex];
            var selectedCode = selectedOption.value;
            document.getElementById('inspCodeInputForm').value = selectedCode || '';
        });

    document.getElementById('reworklabel-file').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    reworkLabelXml = e.target.result;
                    showAlert("ReworkLabel.dymo file loaded successfully! Click 'Show Label Object Names' to verify.", 'alert-success');
                } catch (e) {
                    showAlert("Error loading ReworkLabel.dymo file: " + e.message, 'alert-error');
                    console.error("Error loading ReworkLabel.dymo:", e);
                }
            };
            reader.readAsText(file);
        });
        
            // Fetch ReworkLabel.dymo from server on load
            async function fetchReworkLabelFile() {
                try {
                    const response = await fetch('/static/ReworkLabel.dymo');
                    if (!response.ok) throw new Error('File not found');
                    reworkLabelXml = await response.text();
                } catch (e) {
                    showAlert("Could not load ReworkLabel.dymo from server.", 'alert-error');
                }
            }
            fetchReworkLabelFile();

            function getLabelObjectNames() {
                if (!reworkLabelXml) {
                    showAlert("ReworkLabel.dymo file not loaded from server.", 'alert-error');
                    return;
                }
                try {
                    var label = dymo.label.framework.openLabelXml(reworkLabelXml);
                    var objectNames = label.getObjectNames().join(', ');
                    alert("Object Names in the label file:\n\n" + objectNames);
                } catch (e) {
                    showAlert("Error getting object names: " + e.message, 'alert-error');
                }
            }

        async function logReworkAndPrint() {
            // Check if DYMO framework is loaded
            if (typeof dymo === 'undefined' || !dymo.label.framework) {
                showAlert("DYMO framework is not loaded. Please ensure 'dymo.connect.framework.js' is in the same folder as this file.", 'alert-error');
                return;
            }
            
            var jobNo = document.getElementById('jobNoInput').value.trim();
            var disposition = document.getElementById('dispositionSelect').value.trim();
            var inspCode = document.getElementById('inspCodeInputForm').value.trim();
            var inspDescription = document.getElementById('inspDescriptionSelect').options[document.getElementById('inspDescriptionSelect').selectedIndex].text.trim();
            var clockNum = document.getElementById('clockNoInput').value.trim();
            var quantity = document.getElementById('quantityInput').value;
            var Comment = document.getElementById('commentInput').value.trim();

            if (!jobNo || !disposition || !inspCode || !clockNum || !quantity || Number(quantity) < 1) {
                showAlert("Please fill in all required fields.", 'alert-error');
                return;
            }
            if (!reworkLabelXml) {
                showAlert("Please upload the ReworkLabel.dymo file first.", 'alert-error');
                return;
            }

            // Collect all data to send
            var dataToSend = {
                timestamp: getFormattedDate(),
                jobNo: jobNo,
                disposition: disposition,
                inspCode: inspCode,
                inspDescription: inspDescription,
                clockNum: clockNum,
                Comment: Comment,
                quantity: quantity
            };
            
            // NEW: Add the extra fields if disposition is "Scrap and Remake"
            if (disposition === 'Scrap and Remake') {
                dataToSend.programNo = document.getElementById('programNoInput').value.trim();
                dataToSend.newDescription = document.getElementById('newDescriptionInput').value.trim();
                dataToSend.xAxis = document.getElementById('xAxisInput').value.trim();
                dataToSend.yAxis = document.getElementById('yAxisInput').value.trim();
                dataToSend.gaugeMaterial = document.getElementById('gaugeMaterialInput').value.trim();
            }

            // Print Label
            try {
                var printers = dymo.label.framework.getPrinters();
                if (printers.length === 0) {
                    throw new Error("No DYMO printers are installed or connected.");
                }
                var printer = printers.find(p => p.modelName === "DYMO LabelWriter 550");
                if (!printer) {
                    throw new Error("DYMO LabelWriter 550 not found!");
                }
                var label = dymo.label.framework.openLabelXml(reworkLabelXml);
                var combinedInspText = `${inspCode} - ${inspDescription}`;
                
                label.setObjectText('fJobNo', jobNo);
                label.setObjectText('Dispo', disposition);
                label.setObjectText('InspectionCode', combinedInspText);
                label.setObjectText('ClockNum', clockNum);
                label.setObjectText('Comment', Comment);
                
                label.print(printer.name);
                showAlert("Labels sent to printer!", 'alert-success');
            } catch (e) {
                showAlert("An error occurred during printing: " + e.message, 'alert-error');
                console.error("Error during printing:", e);
            }
            
            // Send rework data to Teams server
            try {
                const response = await fetch('http://localhost:5000/log-rework', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                const data = await response.json();
                if (response.ok) {
                    showAlert("Teams notification sent successfully!", 'alert-success');
                    clearFormFields();
                } else {
                    showAlert("Error sending Teams notification: " + (data.error || 'Unknown error'), 'alert-error');
                }
            } catch (e) {
                showAlert("Could not connect to the Teams server. Please make sure the 'teams_rework_server.py' script is running in the background. " + e.message, 'alert-error');
                console.error("Error connecting to server:", e);
            }
            }
        </script>
    </body>
    </html>